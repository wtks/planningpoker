# オンライン planning poker

## コンセプト

- データベースを持たない、サーバーレスに近い構成のリアルタイムプランニングポーカーアプリケーション。
- ユーザーアカウントは不要で、手軽に利用を開始できる。

## ルーム機能

- **ルームへの参加:**
    - ユーザーは任意の名前を入力するだけでルームに参加できる。ユーザーアカウントの概念は存在しない。
    - ルームはランダムなURL（ID）によって一意に識別される。
    - フロントエンドでランダムなIDを生成し、そのURLにアクセスすることでルームが作成（存在）される。
    - 同じIDのURLにアクセスしたユーザーは、同じルームに参加する。

## ポーカー機能

- **カード:**
    - カードの数字はフィボナッチ数列（例: 0, 1, 2, 3, 5, 8, 13, 21...）とする。
- **投票:**
    - 参加者はそれぞれ１枚のカードを選択して投票する。
- **カードのオープン:**
    - ルームにいる参加者全員がカードを選択した時点、または「カードをオープンする」ボタンが押された時点で、3秒間のカウントダウンが画面に表示される。
    - カウントダウン終了後、全員のカードがオープンされる。

## 投票結果

- **結果表示:**
    - 各参加者が選択したカードの数字が一覧で表示される。
    - 参加者全員が選択したカードの数字の平均値が表示される。
- **リアルタイム更新:**
    - 投票結果が表示されている間、参加者は自分のカードの選択を変更できる。
    - 変更は即座に他の参加者の画面にもリアルタイムで反映される。
    - 平均値も選択の変更に応じてリアルタイムで再計算される。

## 進行管理

- **次のポーカーへ:**
    - 「次のポーカーに進む」ボタンが用意されている。
    - いずれかの参加者がボタンを押すと、全員の投票状態がリセットされ、再びカード選択からポーカーを再開できる。

## 画面仕様（ポーカー画面）

- **カード選択エリア:**
    - 画面下部に、投票に使用するフィボナッチ数列のカードが横一列に並んで表示される。
    - ユーザーはここからカードをクリックして選択する。

- **フィールドエリア（中央）:**
    - **クローズ状態（投票中）:**
        - 各参加者が選択したカードが、名前とともに伏せられた状態で表示される。
        - 誰が選択済みで、誰が未選択かがわかるようになっている。
    - **オープン状態（結果表示中）:**
        - 全員のカードがオープンになり、選択した数字が見える状態で表示される。
        - 画面上の目立つ位置に、全員の投票結果の「平均値」が表示される。
        - この状態でも、ユーザーは画面下部のカードを再選択でき、選択内容はリアルタイムでフィールドと平均値に反映される。

- **進行リセット:**
    - 「次のポーカーに進む」ボタンを押すと、フィールドエリアの全ユーザーのカードがリセットされ、再びクローズ状態に戻る。

## スコープ外

以下の機能は本アプリケーションには含まない。

- タスク管理機能
- チャット機能
- タイマー機能

## 技術スタック

- **実行環境/サーバー:** Bun
- **言語:** TypeScript
- **フロントエンドフレームワーク:** React (Vite)
- **リアルタイム通信:** Bun内蔵のWebSocketサーバー
- **CSS:** Tailwind CSS
- **Linter/Formatter:** Biome
- **クライアント状態管理:** Jotai

## サーバーのステート管理

- **インメモリ管理:** ルームの状態（参加者、投票状況など）は、すべてサーバーのメモリ上で管理する。データベースは使用しない。
- **自動クリーンアップ:** WebSocketの接続が切れ、ルーム内のアクティブなユーザーが0人になった場合、サーバーはそのルームの情報をメモリから自動的に削除する。これにより、不要なデータが残り続けることを防ぐ。

## アーキテクチャ

- **開発環境:**
    - フロントエンドはVite開発サーバー（HMR有効）で、バックエンドはBunのWebSocketサーバーをそれぞれ別々に起動する。
    - フロントエンドからWebSocketサーバーへ接続する。
- **本番環境:**
    - フロントエンドは`vite build`によって静的ファイル（HTML, CSS, JS）にビルドされる。
    - Bunサーバーが単一で起動し、WebSocketリクエストの処理と、ビルドされた静的ファイルの配信の両方を行う。
- **型安全性:**
    - Bunのワークスペース機能を利用して、クライアント・サーバー間の型安全性を確保する。
    - `server`プロジェクトで定義したWebSocket通信用の型（メッセージ形式など）を`export`する。
    - `client`プロジェクトは、`workspace:*`プロトコルを利用して`server`プロジェクトに依存する。
    - これにより、クライアントはサーバーの型定義を直接インポートでき、コンパイル時に通信データの型チェックが可能になる。

## ディレクトリ構成

```
/
├── client/                  # フロントエンド (Vite + React)
│   ├── src/
│   ├── package.json
│   └── ...
├── server/                  # バックエンド (Bun WebSocket)
│   ├── src/
│   │   └── index.ts
│   └── package.json
├── .gitignore
├── bun.lockb
├── biome.json               # Biomeの設定ファイル (共通)
├── package.json             # プロジェクト全体を管理
└── README.md
```